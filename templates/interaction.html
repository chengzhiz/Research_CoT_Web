{% extends "base.html" %}
{% block content %}
<div class="container">
  <br>
  <div class="row justify-content-center">
    <!-- First Card -->
    <div class="col-md-4">
      <div class="card text-left mb-3" style="width: 100%;">
        <div class="card-body">
          <h5 class="card-title">Prompt A Question</h5>
          <p class="card-text">Please hit the button for voice input</p>
          <a href="#" class="btn btn-primary" onmousedown="startListening()" onmouseup="stopListening()">Press to
            speak</a>
          <p class="card-text" id="voice-input"></p>
          <p class="card-text" id="question">
            Waiting for a question...
          </p>
          <p class="card-text"><strong>Answer:</strong> <span id="answer">{{ answer }}</span></p>
          <p class="card-text"><strong>Category:</strong> <span id="category_name">{{ category_name }}</span></p>
          <p class="card-text"><strong>Justification:</strong> <span id="justification">{{ justification }}</span></p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card" style="width: 24rem;">
        <img src="/imgs/mot.png" class="card-img-top" alt="lot">
        <ul class="list-group list-group-flush">
          <li class="list-group-item">&nbsp Chatbot of Truth</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Audio elements for voice files -->
<audio id="intro-audio" src="{{ url_for('static', filename='voice/intro.wav') }}" preload="auto"></audio>
<audio id="yes-audio" src="{{ url_for('static', filename='voice/yes.wav') }}" preload="auto"></audio>
<audio id="no-audio" src="{{ url_for('static', filename='voice/no.wav') }}" preload="auto"></audio>
<audio id="idk-audio" src="{{ url_for('static', filename='voice/idk.wav') }}" preload="auto"></audio>
<audio id="reask-audio" src="{{ url_for('static', filename='voice/reask.wav') }}" preload="auto"></audio>

<script>
  // Initialize SpeechRecognition
  let recognition;
  let isListening = false;

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition(); // Using Google Web Speech API
  } else {
    alert('Your browser does not support Google Web Speech API. Please use Chrome.');
  }

  if (recognition) {
    recognition.continuous = false; // Stop listening after a phrase
    recognition.interimResults = false; // Only provide final results
    recognition.lang = 'en-US'; // Set language to English (US)

    recognition.onresult = function (event) {
      const transcript = event.results[0][0].transcript;

      // Format the transcript: Capitalize the first letter and add a question mark
      const formattedTranscript = transcript.charAt(0).toUpperCase() + transcript.slice(1).trim() + "?";

      // Update the voice-input and question elements
      document.getElementById('question').innerText = formattedTranscript; // Replace default text

      // Automatically call askChatGPT
      askChatGPT();
    };

    recognition.onerror = function (event) {
      console.error('Speech Recognition Error:', event.error);
    };
  }

  function startListening() {
    if (!recognition || isListening) return;
    isListening = true;
    recognition.start();
  }

  function stopListening() {
    if (!recognition || !isListening) return;
    isListening = false;
    recognition.stop();
  }

  // JavaScript function to call ask_chatgpt with the question
  function askChatGPT() {
    const userQuestion = document.getElementById('question').innerText;

    fetch('/ask-chatgpt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ question: userQuestion }),
    })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById('answer').innerText = data.answer;
        document.getElementById('category_name').innerText = data.category_name;
        document.getElementById('justification').innerText = data.justification;
      })
      .catch((error) => console.error('Error retrieving answer:', error));
  }

  // Audio playback logic remains unchanged
</script>
{% endblock %}